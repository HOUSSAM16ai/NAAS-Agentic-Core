# التشخيص المعماري الأعلى خطورة (تشخيص واحد فقط)

## المشكلة الأخطر: **انقسام سلطة التنسيق (Split-Brain Orchestration Authority) وتحول النظام إلى Monolith موزّع**

> **الخلاصة التنفيذية:** النظام يعرّف أكثر من «مركز قيادة» فعلي لتنسيق المهام الحرجة (Missions)، مع تناقض رسمي بين وثائق القرار المعماري والتنفيذ الحي. هذا ليس عيبًا محليًا؛ بل «خلل سيادي» في طبقة الحوكمة المعمارية نفسها. عند التوسع المستقبلي (AI Agents أكثر، أحمال أعلى، فرق أكثر)، هذه المشكلة تتحول إلى مضاعف فشل Systemic Failure Multiplier.

---

## لماذا هذه هي المشكلة الأخطر (وليس غيرها)

لأنها تضرب **أعلى طبقة قرار** في المنظومة:
1. **الملكية (Ownership):** من يملك الحقيقة النهائية لحالة المهمة؟
2. **السلطة (Authority):** من يقرر مسار التنفيذ؟
3. **الحدود (Boundaries):** أين ينتهي دور الـ API Gateway ويبدأ دور المنسّق؟
4. **الاتساق (Consistency):** كيف نضمن عدم وجود مسارين متوازيين يبدوان صحيحين محليًا لكنهما متعارضان عالميًا؟

أي خلل في هذه النقاط يعطل قابلية المنصة للنمو لعقدٍ قادم، حتى لو كانت بقية الطبقات «نظيفة».

---

## دلائل التناقض البنيوي (Structural Contradictions)

### 1) قرار معماري يقول: منسّق وحيد (Sole Coordinator)
- ADR-001 يقرر بوضوح أن `orchestrator_service` هو المنسق الوحيد.

### 2) وثيقة معمارية تشغيلية تقول العكس
- `ARCHITECTURE.md` يعيّن `app/services/overmind` كـ Control Plane، ويعتبر `microservices/orchestrator_service` مكوّنًا ثانويًا/مهمّشًا في التنفيذ.

### 3) التنفيذ الفعلي داخل `app` يمارس التنسيق الكامل
- `app/services/overmind/entrypoint.py` ينشئ المهمة، يقفلها Redis Lock، يطلق تشغيلًا خلفيًا، ويستدعي منسق التنفيذ الداخلي مباشرة.
- `app/api/routers/overmind.py` يستدعي `start_mission` داخليًا في نفس التطبيق/العملية.

### 4) خدمة orchestrator_service قائمة وتقدم واجهات مهام مستقلة
- `microservices/orchestrator_service/main.py` ينشر `/missions` ويدير MissionManager خاصًا به.

**النتيجة:** المنظومة تمتلك «سرديتين» متضادتين حول السلطة التنفيذية. في الأنظمة الذكية طويلة الأجل، هذا يُعد خطرًا وجوديًا معماريًا.

---

## لماذا هذا الخلل مدمر مستقبليًا (Long-Horizon Impact)

## أ) مخاطر الاتساق السببي (Causal Consistency)
عند وجود أكثر من مسار تنسيق، يمكن أن تحصل:
- إعادة ترتيب أحداث مهمة واحدة بوجهتي نظر مختلفتين.
- حالات نهائية متضاربة لنفس Mission ID على ممرات مختلفة.
- تقارير observability «صحيحة محليًا وخاطئة عالميًا».

## ب) انهيار قابلية التوسع التنظيمي (Org-Scale Failure)
مع تعدد الفرق:
- فريق يبني على ADR.
- فريق يبني على ARCHITECTURE.md.
- فريق ثالث يبني على السلوك الفعلي في `app`.

فتنشأ **3 خرائط ذهنية متنافسة** لنفس النظام؛ وهذه أخطر من أي Bug تقني عابر.

## ج) تضخم كلفة التغيير (Change Amplification)
أي تغيير في دورة المهمة سيحتاج مزامنة عبر مسارات تنسيق متعددة، فيتحول التغيير البسيط إلى برنامج هجرة معقّد عالي المخاطر.

## د) خطر «المونوليث الموزّع»
المظهر الخارجي Microservices، لكن السلطة التنفيذية وحدود الملكية غير محسومة فعليًا => تفقد المنصة مزايا الخدمات المصغرة (الاستقلال، النشر المستقل، العزل الحقيقي للأعطال).

---

## تقييم الخطورة الهندسية

- **Severity (الشدة):** حرجة جدًا / Critical
- **Blast Radius (نطاق الأثر):** شامل (API, Orchestration, Data Flow, UX, Observability)
- **Detectability (قابلية الاكتشاف):** منخفضة مبكرًا، عالية فقط بعد التعقيد التشغيلي
- **Time-to-Failure (زمن الانكشاف):** يتسارع مع كل توسع في عدد الوكلاء والمهام المتزامنة

> هذه ليست مجرد مشكلة «أداء» أو «تنظيم ملفات»؛ بل مشكلة **سيادة معمارية** تمس صحة النظام الكلية على المدى البعيد.

---

## صياغة تشخيصية نهائية (Single Verdict)

**أخطر مشكلة معمارية في المشروع هي ازدواج/تضارب سلطة orchestration بين المسار الداخلي في `app/services/overmind` والمسار الخدمي `microservices/orchestrator_service` مع تناقض وثائقي رسمي حول من هو المنسق الوحيد.**

هذا الخلل يضع المشروع على مسار مخاطر تراكمية عالية تؤدي إلى distributed monolith غير قابل للحوكمة عند النمو.

> **لا يتضمن هذا المستند أي تعديل أو اقتراح تنفيذي؛ هو تشخيص نوعي/معماري عالي الدقة لمشكلة واحدة فقط كما طُلب.**
